<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>MultiSig Treasury</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, Arial; background:#0b1021; color:#e6f0ff; padding:24px; }
    .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:16px; }
    .card { background:#0e1533; border:1px solid #1c2b4a; border-radius:16px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,.25); }
    input, textarea { width:100%; padding:8px 10px; background:#0b1021; color:#e6f0ff; border:1px solid #2b3d6b; border-radius:10px; }
    label { font-size:12px; color:#9ab3ff; }
    button { padding:10px 14px; border-radius:12px; background:#2f6fff; color:#fff; border:0; cursor:pointer; }
    .row { display:flex; gap:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; white-space:pre-wrap; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #1c2b4a; padding:8px; text-align:left; }
    .pill { padding:2px 8px; border-radius:999px; font-size:12px; background:#24325a; }
  </style>
</head>
<body>
  <h1>MultiSig Treasury</h1>
  <div class="row" style="margin-bottom:16px;">
    <button id="connect">Connect</button>
    <div>Wallet: <span id="account" class="mono"></span></div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Contract</h3>
      <div class="row">
        <div style="flex:1">
          <label>MultiSig Address</label>
          <input id="wallet" placeholder="0x..." />
        </div>
        <div style="width:160px; align-self:flex-end"><button id="load">Load</button></div>
      </div>
      <div style="margin-top:12px">
        <div>Owners: <span id="owners" class="mono"></span></div>
        <div>Required: <span id="required" class="pill"></span></div>
        <div>Tx Count: <span id="txcount" class="pill"></span></div>
      </div>
    </div>

    <div class="card">
      <h3>Submit Tx</h3>
      <div class="row">
        <div><label>To</label><input id="to" placeholder="0x..."/></div>
        <div><label>Value (ETH)</label><input id="value" value="0"/></div>
      </div>
      <div style="margin-top:10px;"><label>Data (hex)</label><textarea id="data" rows="3" placeholder="0x"></textarea></div>
      <div style="margin-top:10px;"><button id="submit">Submit</button></div>
      <div id="subres" class="mono" style="margin-top:8px;"></div>
    </div>

    <div class="card" style="grid-column:1 / span 2">
      <h3>Transactions</h3>
      <table>
        <thead><tr><th>ID</th><th>To</th><th>Value</th><th>Confirmed</th><th>Executed</th><th>Actions</th></tr></thead>
        <tbody id="txs"></tbody>
      </table>
    </div>

    <div class="card" style="grid-column:1 / span 2">
      <h3>Meta-Confirm (EIP-712)</h3>
      <div class="row">
        <div><label>Tx ID</label><input id="mc_txid" value="0"/></div>
        <div><label>Deadline (+min)</label><input id="mc_deadline" value="10"/></div>
      </div>
      <div style="margin-top:10px;" class="row">
        <div><button id="mc_sign">Prepare & Sign</button></div>
        <div><label>Relay URL</label><input id="mc_url" value="http://localhost:8788/confirm"/></div>
        <div><button id="mc_send">Send to Relayer</button></div>
      </div>
      <div id="mc_out" class="mono" style="margin-top:10px"></div>
    </div>

    <div class="card" style="grid-column:1 / span 2">
      <strong>Logs</strong>
      <div id="log" class="mono"></div>
    </div>
  </div>

<script>
let provider, signer, wallet;

function log(msg){ const el = document.getElementById('log'); el.textContent += (typeof msg==='string'?msg:JSON.stringify(msg)) + "\n"; }

async function connect() {
  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  document.getElementById('account').textContent = await signer.getAddress();
  log("connected");
}
document.getElementById('connect').onclick = connect;

async function loadInfo() {
  const addr = document.getElementById('wallet').value.trim();
  wallet = new ethers.Contract(addr, [
    "function getOwners() view returns(address[])",
    "function required() view returns(uint256)",
    "function transactionCount() view returns(uint256)",
    "function transactions(uint256) view returns(address to,uint256 value,bytes data,bool executed,uint256 numConfirmations)",
    "function confirmations(uint256,address) view returns(bool)",
    "function submit(address to,uint256 value,bytes data) returns(uint256)",
    "function confirm(uint256 txId)",
    "function revoke(uint256 txId)",
    "function execute(uint256 txId)",
    "function confirmBySig(uint256 txId,uint256 deadline,uint8 v,bytes32 r,bytes32 s)"
  ], signer || provider);
  const owners = await wallet.getOwners();
  const required = await wallet.required();
  const count = await wallet.transactionCount();
  document.getElementById('owners').textContent = owners.join(", ");
  document.getElementById('required').textContent = required;
  document.getElementById('txcount').textContent = count;
  renderTxs(count, owners);
}
document.getElementById('load').onclick = loadInfo;

async function renderTxs(count, owners) {
  const tbody = document.getElementById('txs'); tbody.innerHTML = "";
  for (let i=0;i<count;i++) {
    const t = await wallet.transactions(i);
    const tr = document.createElement('tr');
    const valEth = ethers.formatEther(t.value);
    const confs = Number(t.numConfirmations);
    tr.innerHTML = \`<td>\${i}</td><td>\${t.to}</td><td>\${valEth}</td><td>\${confs}/\${owners.length}</td><td>\${t.executed}</td>
      <td>
        <button data-act="confirm" data-id="\${i}">Confirm</button>
        <button data-act="revoke" data-id="\${i}">Revoke</button>
        <button data-act="execute" data-id="\${i}">Execute</button>
      </td>\`;
    tbody.appendChild(tr);
  }
  tbody.onclick = async (e)=>{
    const b = e.target.closest('button'); if (!b) return;
    const id = parseInt(b.dataset.id,10);
    try {
      if (b.dataset.act==="confirm") await (await wallet.confirm(id)).wait();
      if (b.dataset.act==="revoke") await (await wallet.revoke(id)).wait();
      if (b.dataset.act==="execute") await (await wallet.execute(id)).wait();
      await loadInfo();
    } catch(err){ log(err.reason || err.message || err); }
  };
}

document.getElementById('submit').onclick = async () => {
  try {
    const to = document.getElementById('to').value.trim();
    const value = ethers.parseEther(document.getElementById('value').value || "0");
    const data = document.getElementById('data').value.trim() || "0x";
    const tx = await wallet.submit(to, value, data);
    const r = await tx.wait();
    document.getElementById('subres').textContent = r.hash;
    await loadInfo();
  } catch(e) { log(e.reason || e.message || e); }
};

document.getElementById('mc_sign').onclick = async () => {
  const id = BigInt(document.getElementById('mc_txid').value || "0");
  const addMin = parseInt(document.getElementById('mc_deadline').value || "10", 10);
  const now = Math.floor(Date.now()/1000);
  const deadline = BigInt(now + addMin*60);
  const [to,value,data,executed] = await wallet.transactions(id);
  const txHash = ethers.keccak256(ethers.AbiCoder.defaultAbiCoder().encode(["address","uint256","bytes32"], [to,value,ethers.keccak256(data)]));
  const domain = { name:"MultiSigWallet", version:"1", chainId:(await provider.getNetwork()).chainId, verifyingContract: wallet.target };
  const types = { Confirm:[
    {name:"txId",type:"uint256"},
    {name:"wallet",type:"address"},
    {name:"txHash",type:"bytes32"},
    {name:"deadline",type:"uint256"}
  ]};
  const message = { txId: id, wallet: wallet.target, txHash, deadline };
  const sig = await signer.signTypedData(domain, types, message);
  document.getElementById('mc_out').textContent = JSON.stringify({ walletAddr: wallet.target, txId: id.toString(), deadline: deadline.toString(), signature: sig }, null, 2);
};

document.getElementById('mc_send').onclick = async () => {
  try {
    const url = document.getElementById('mc_url').value.trim();
    const payload = JSON.parse(document.getElementById('mc_out').textContent || "{}");
    const r = await fetch(url, { method:"POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    const j = await r.json();
    log("Relayer: " + JSON.stringify(j));
  } catch(e){ log(e.message||e); }
};

// auto-load from deployment.json if present
(async function(){
  try {
    const resp = await fetch('deployment.json', { cache: 'no-store' });
    if (resp.ok) {
      const d = await resp.json();
      document.getElementById('wallet').value = d.wallet || "";
    }
  } catch(e){}
})();
</script>
</body>
</html>
